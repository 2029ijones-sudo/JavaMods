<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>JavaMods</title>
<style>
  body { font-family: sans-serif; background: #f0f0f0; margin: 20px; }
  #controls { margin-bottom: 10px; }
  #uploaders input { display: block; margin: 5px 0; }
  #console { background: #222; color: #0f0; padding: 10px; height: 150px; overflow-y: auto; white-space: pre-wrap; }
  canvas { border: 1px solid #000; display: block; margin-top: 10px; }
  button { margin-top: 5px; }
</style>
</head>
<body>

<h1>JavaMods</h1>

<div id="controls">
  <div id="modeSelector">
    <label><input type="radio" name="mode" value="world" checked> World Mode</label>
    <label><input type="radio" name="mode" value="test"> Test Mode</label>
  </div>

  <div id="uploaders">
    <label>Upload World (.mcworld): <input type="file" id="worldInput" accept=".mcworld,.zip"></label>
    <label>Upload Mod (.zip): <input type="file" id="modInput" accept=".zip,.js" disabled></label>
  </div>

  <button id="runBtn">Run Sandbox</button>
</div>

<pre id="console"></pre>
<canvas id="screen" width="800" height="600"></canvas>

<script type="module">
import * as THREE from "https://cdn.jsdelivr.net/npm/three@0.162.1/build/three.module.js";
import { OrbitControls } from "https://cdn.jsdelivr.net/npm/three@0.162.1/examples/jsm/controls/OrbitControls.js";
import * as JSZip from "https://cdn.jsdelivr.net/npm/jszip@3.10.1/+esm";


const consoleEl = document.getElementById("console");
function log(msg) { consoleEl.textContent += msg + "\n"; consoleEl.scrollTop = consoleEl.scrollHeight; }

let mode = "world";
let worldData = null;
let modsData = null;
const modInput = document.getElementById("modInput");

// Mode selection
document.querySelectorAll('input[name="mode"]').forEach(radio => {
  radio.addEventListener("change", e => {
    mode = e.target.value;
    log("Mode set to " + mode);
    modInput.disabled = (mode === "world"); // Only enable mod upload in Test Mode
  });
});

// World upload
document.getElementById("worldInput").addEventListener("change", async e => {
  if (!e.target.files.length) return;
  const file = e.target.files[0];
  worldData = await JSZip.loadAsync(file);
  log("World loaded: " + file.name);
});

// Mod upload (Test Mode only)
modInput.addEventListener("change", async e => {
  if (!e.target.files.length) return;
  const file = e.target.files[0];
  const zip = await JSZip.loadAsync(file);
  modsData = [];
  for (const name in zip.files) {
    if (name.endsWith(".js")) {
      const code = await zip.file(name).async("string");
      modsData.push(code);
    } else if (name.endsWith(".jar")) {
      // Keep .jar mods in memory to add to world
      const jarData = await zip.file(name).async("uint8array");
      modsData.push({ name, jarData });
    }
  }
  log("Mods loaded: " + file.name);
});

// Run Sandbox
document.getElementById("runBtn").addEventListener("click", async () => {
  if (!worldData) { log("No world uploaded"); return; }
  if (mode === "test" && (!modsData || modsData.length === 0)) { log("No mods uploaded for Test Mode"); return; }

  log("Preparing sandbox...");

  // Ensure javamods folder exists
  let jmFolder = worldData.folder("javamods");
  if (!jmFolder) jmFolder = worldData.folder("javamods");

  if (mode === "world") {
    jmFolder.file("mods_enabled.flag", "true");
    log("World modified to accept JS/JAR mods");
  } else if (mode === "test") {
    jmFolder.file("encrypted.flag", "true");
    log("World encrypted for Test Mode");

    // Add uploaded .jar mods inside javamods/
    modsData.forEach(mod => {
      if (mod.jarData) {
        jmFolder.file(mod.name, mod.jarData);
        log("Added JAR mod: " + mod.name);
      }
    });
  }

  // Three.js 3D sandbox
  const canvas = document.getElementById("screen");
  const scene = new THREE.Scene();
  scene.background = new THREE.Color(0x87ceeb);

  const camera = new THREE.PerspectiveCamera(75, canvas.width / canvas.height, 0.1, 1000);
  camera.position.set(5, 10, 15);

  const renderer = new THREE.WebGLRenderer({ canvas });
  renderer.setSize(canvas.width, canvas.height);

  const controls = new OrbitControls(camera, renderer.domElement);

  const light = new THREE.DirectionalLight(0xffffff, 1);
  light.position.set(10, 20, 10);
  scene.add(light);

  const grid = new THREE.GridHelper(50, 50);
  scene.add(grid);

  // JS mods runtime (Test Mode)
  const JavaMods = { items: {}, registerItem(item) {
    this.items[item.id] = item;
    log("Item registered: " + item.id);
    const geometry = new THREE.BoxGeometry(1, 1, 1);
    const texture = new THREE.TextureLoader().load(item.texture || "");
    const material = new THREE.MeshStandardMaterial({ map: texture });
    const cube = new THREE.Mesh(geometry, material);
    cube.position.set(Math.random()*10, 1, Math.random()*10);
    scene.add(cube);
    item.mesh = cube;
  }};
  if (mode === "test") {
    modsData.forEach(code => {
      if (typeof code === "string") new Function("JavaMods", code)(JavaMods);
    });
  }

  function animate() {
    requestAnimationFrame(animate);
    controls.update();
    renderer.render(scene, camera);
  }
  animate();

  // Export modified world
  const blob = await worldData.generateAsync({ type: "blob" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "JavaModsWorld.mcworld";
  a.click();
  log("Sandbox running. Modified world downloaded.");
});
</script>

</body>
</html>
